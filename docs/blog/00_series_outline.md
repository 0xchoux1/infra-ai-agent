# WordPress マルチテナント環境構築 ブログ記事シリーズ 全体構成

## シリーズコンセプト

GCP上でWordPress マルチテナント環境を構築する過程で遭遇した **失敗、判断ミス、そこから得られた学び** を包み隠さず共有する技術ブログシリーズ。

**ターゲット読者**:
- GCP/AWS等でWordPress環境を構築するインフラエンジニア
- Terraform/Ansibleを使ったIaC運用に興味があるエンジニア
- 失敗から学ぶことの重要性を理解しているエンジニア

---

## 記事構成（全5記事）

### 【優先度: 最高】失敗分析・改善編

#### 記事4: 【失敗から学ぶ】Cloud SQL SSL設定で2時間ハマった話 - 判断ミスの分析と再発防止策
**執筆優先度**: ★★★★★（最優先）

**狙い**: 同じミスを繰り返さないための振り返りと、読者への警鐘

**構成**:
1. **問題の発生経緯**（5分）
   - SSL証明書エラーに遭遇した瞬間
   - 最初に取った「間違った」アプローチ

2. **判断ミス1: カスタムdb.phpによる対症療法**（10分）
   - なぜカスタムdb.phpを作ったのか
   - この判断の何が問題だったのか
   - 正しい判断: インフラ層の設定を疑うべきだった

3. **判断ミス2: Terraformでの根本対応を後回しにした**（10分）
   - 「とりあえず動けばいい」という思考の罠
   - IaC原則違反: 手動対応の積み重ねが招く負債
   - 正しい判断: 最初からTerraformで`require_ssl = false`にすべきだった

4. **時系列でみる判断の分岐点**（10分）
   - タイムライン図: どこで正しい方向に戻れたか
   - 各ポイントでの「取るべきだった行動」

5. **根本原因分析: なぜ判断を誤ったのか**（15分）
   - **原因1**: Cloud SQLのデフォルト設定への理解不足
   - **原因2**: エラーメッセージの表面的な読み取り
   - **原因3**: アプリケーション層で解決しようとするバイアス
   - **原因4**: IaC原則の理解不足（「動けばいい」思考）

6. **再発防止策: 同様の事象が起きた時のチェックリスト**（10分）
   ```
   □ エラーの根本原因はインフラ層かアプリ層か？
   □ デフォルト設定を確認したか？
   □ 対症療法ではなく根本対応か？
   □ IaC原則に従っているか？
   □ 将来の運用コストを考慮したか？
   ```

7. **学んだこと・読者へのメッセージ**（5分）

**想定読了時間**: 50分
**キーワード**: Cloud SQL, SSL, 失敗分析, IaC, 判断ミス

---

#### 記事5: WordPress環境構築で遭遇した5つのハマりポイントと解決策
**執筆優先度**: ★★★★☆

**狙い**: 具体的なトラブル事例の共有による実務での時間短縮

**構成**:
1. **イントロ: なぜハマったのか**（5分）
   - マルチテナント WordPress特有の複雑さ
   - 今回の環境の特殊性

2. **ハマりポイント1: Ansibleのメタデータ取得で404エラー**（10分）
   - **症状**: HTML404エラーページがスクリプトに埋め込まれる
   - **原因**: GCPメタデータが存在しない場合のエラーハンドリング不足
   - **解決**: HTTPステータスコードチェックの追加
   ```yaml
   db_host: "{{ db_host_metadata.content if ... and db_host_metadata.status == 200 else ... }}"
   ```

3. **ハマりポイント2: Terraform applyでインスタンス再作成**（10分）
   - **症状**: 設定変更で既存インスタンスが削除される
   - **原因**: instance_templateの変更検知
   - **教訓**: create_before_destroy とステートフルな構成の理解

4. **ハマりポイント3: データベースパスワード不一致**（10分）
   - **症状**: `ERROR 1045 (28000): Access denied`
   - **原因**: Secret Managerとデータベースの不整合
   - **解決**: パスワード同期スクリプト
   ```bash
   for i in {1..10}; do
     PASS=$(gcloud secrets versions access latest --secret=...)
     gcloud sql users set-password ...
   done
   ```

5. **ハマりポイント4: WP-CLIの権限エラー**（10分）
   - **症状**: `--allow-root` エラー
   - **原因**: rootユーザーでのWP-CLI実行
   - **解決**: `become_user: www-data`

6. **ハマりポイント5: カスタムdb.phpの残骸**（10分）
   - **症状**: `Call to undefined function wp_kses()`
   - **原因**: 古いSSL対応ファイルが残っていた
   - **解決**: NFSマウントされたファイルの完全削除

7. **まとめ: トラブルシューティングの心得**（5分）

**想定読了時間**: 60分
**キーワード**: WordPress, トラブルシューティング, Ansible, GCP

---

### 【標準】技術実装編

#### 記事1: GCP上でWordPress マルチテナント環境を構築 - アーキテクチャ設計編
**執筆優先度**: ★★★☆☆

**構成**:
1. 要件定義（10サイトのマルチテナント）
2. アーキテクチャ選定理由
   - Cloud SQL（プライベートIP、SSL無効）
   - Cloud Filestore（NFS共有ストレージ）
   - Managed Instance Group（オートスケーリング）
3. コスト試算
4. セキュリティ考慮事項

**想定読了時間**: 40分

---

#### 記事2: Terraform + Ansibleで実現する完全IaC運用
**執筆優先度**: ★★★☆☆

**構成**:
1. TerraformとAnsibleの責任分離
2. モジュール設計
3. 変数管理（tfvars, inventory）
4. 冪等性の担保

**想定読了時間**: 50分

---

#### 記事3: Cloud SQL接続の落とし穴 - SSL設定とトラブルシューティング
**執筆優先度**: ★★★☆☆

**構成**:
1. Cloud SQLのSSL要件
2. プライベートIP vs パブリックIP
3. 接続エラーのデバッグ手法
4. パスワード管理（Secret Manager）

**想定読了時間**: 45分

---

## 執筆順序の推奨

1. **記事4**（失敗分析）← 最優先、最も価値が高い
2. **記事5**（ハマりポイント）← 実務で役立つ
3. **記事3**（Cloud SQL）← 技術的深掘り
4. **記事2**（IaC運用）← ベストプラクティス
5. **記事1**（アーキテクチャ）← 概要説明

---

## 各記事の関連性

```
記事1（アーキテクチャ）
    ↓ 設計の背景
記事2（IaC運用）
    ↓ 実装方法
記事3（Cloud SQL）
    ↓ 具体的な技術
記事4（失敗分析）← ★ 最重要
    ↓ 学びの共有
記事5（ハマりポイント）
```

---

## 記事公開戦略

### Phase 1: 失敗から学ぶシリーズ（週1公開）
- Week 1: 記事4公開
- Week 2: 記事5公開

### Phase 2: 技術深掘りシリーズ（週1公開）
- Week 3: 記事3公開
- Week 4: 記事2公開
- Week 5: 記事1公開

---

## 各記事で使用する図表・コード

### 共通リソース
- アーキテクチャ図（Mermaid）
- タイムライン図
- コードスニペット（GitHubリンク）

### 記事4専用
- 判断の分岐点を示すフローチャート
- 正しいアプローチ vs 間違ったアプローチの比較表

### 記事5専用
- トラブルシューティングチェックリスト
- エラーメッセージと解決策の対照表
